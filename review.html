<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Chinese Learning</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF5252',
                        secondary: '#40C4FF',
                        accent1: '#FFEB3B',
                        accent2: '#76FF03',
                        accent3: '#FF4081',
                        accent4: '#BA68C8',
                        neutral: '#333333',
                    },
                    fontFamily: {
                        comic: ['Comic Sans MS', 'Chalkboard SE', 'cursive'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bounce-in {
                animation: bounce-in 0.5s ease-out;
            }
            .wiggle {
                animation: wiggle 0.5s ease-in-out;
            }
            .option-hover {
                transition: all 0.2s ease;
            }
            .option-hover:hover {
                transform: scale(1.02) translateY(-2px);
            }
            .cartoon-bg {
                background-image: 
                    radial-gradient(#FFEB3B 2px, transparent 2px),
                    radial-gradient(#40C4FF 2px, transparent 2px),
                    radial-gradient(#76FF03 2px, transparent 2px);
                background-size: 50px 50px;
                background-position: 0 0, 25px 25px, 40px 15px;
                background-color: #FFF8E1;
            }
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        @keyframes animate-run {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(-5deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }
        
        @keyframes animate-slide {
            0% { left: 0; }
            100% { left: 100%; }
        }
        
        @keyframes animate-spin-slow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin-slow {
            animation: animate-spin-slow 2s linear infinite;
        }
    </style>
</head>
<body class="cartoon-bg min-h-screen font-comic text-neutral flex flex-col items-center justify-start pt-4 pb-8 px-4">
    <!-- 加载动画 -->
    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none">
        <div class="flex flex-col items-center">
            <!-- 卡通旋转加载动画 -->
            <div class="w-24 h-24 bg-gradient-to-r from-primary to-accent1 rounded-full flex items-center justify-center animate-spin-slow shadow-lg">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-secondary to-accent2 rounded-full flex items-center justify-center">
                        <i class="fa fa-smile-o text-white text-4xl animate-bounce"></i>
                    </div>
                </div>
            </div>
            <!-- 加载文本 -->
            <div class="mt-6 text-xl font-bold text-primary animate-pulse">
                Loading...
            </div>
        </div>
    </div>
    <!-- 词汇选择界面 -->
    <div id="wordSelectionScreen" class="fixed inset-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-50 cartoon-bg">
        <div class="w-full max-w-md bg-white rounded-3xl p-8 shadow-xl border-4 border-gradient-to-r from-accent2 to-secondary bounce-in">
            <h2 class="text-2xl font-bold text-primary text-center mb-6">
                <i class="fa fa-book text-accent1 animate-pulse"></i>
                Choose Word Source
            </h2>
            
            <div class="space-y-4">
                <!-- 最新单词选项 -->
                <button id="latestWordsBtn" class="w-full bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 text-lg flex items-center gap-3 option-hover">
                    <i class="fa fa-star text-accent1 text-2xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Review New Words</div>
                    </div>
                </button>
                
                <!-- 困难模式选项 -->
                <button id="hardWordsBtn" class="w-full bg-gradient-to-r from-accent4 to-accent3 hover:opacity-90 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 text-lg flex items-center gap-3 option-hover">
                    <i class="fa fa-fire text-accent1 text-2xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Review New Words_Hard</div>
                    </div>
                </button>
                
                <!-- 以前的单词选项 -->
                <button id="oldWordsBtn" class="w-full bg-gradient-to-r from-secondary to-accent2 hover:opacity-90 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 text-lg flex items-center gap-3 option-hover">
                    <i class="fa fa-history text-accent1 text-2xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Review Previous Words</div>
                    </div>
                </button>
                
                <!-- 合并单词选项 -->
                <button id="combinedWordsBtn" class="w-full bg-gradient-to-r from-accent4 to-accent3 hover:opacity-90 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 text-lg flex items-center gap-3 option-hover">
                    <i class="fa fa-union text-accent1 text-2xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Review All Words</div>
                    </div>
                </button>
            </div>
            
            <!-- 返回按钮 -->
            <button id="selectionBackBtn" class="mt-6 w-full bg-neutral hover:bg-neutral/80 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 text-lg">
                <i class="fa fa-arrow-left mr-2"></i>Back to Menu
            </button>
        </div>
    </div>
    
    <!-- 单词数量选择对话框 -->
    <div id="wordCountDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 shadow-2xl border-4 border-primary max-w-md w-full mx-4 bounce-in">
            <h3 class="text-xl font-bold text-primary text-center mb-6">
                <i class="fa fa-fire text-accent3 animate-pulse"></i>
                Select Review Word Count
            </h3>
            
            <div class="space-y-4">
                <div class="text-left">
                    <label class="block font-bold text-neutral mb-2">Number of previous words to review:</label>
                    <input type="number" id="wordCountInput" min="0" value="5" oninput="if(parseInt(this.value) > parseInt(this.max)) this.value = this.max;" class="w-full px-4 py-3 border-2 border-secondary rounded-xl focus:outline-none focus:ring-2 focus:ring-primary text-lg">
                    <p class="text-sm text-gray-500 mt-1">Minimum: 0, Maximum: all words from words.json</p>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelCountBtn" class="flex-1 bg-neutral hover:bg-neutral/80 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 text-lg">
                        <i class="fa fa-times mr-2"></i>Cancel
                    </button>
                    <button id="confirmCountBtn" class="flex-1 bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 text-lg">
                        <i class="fa fa-check mr-2"></i>Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 游戏标题和返回按钮 -->
    <header class="w-full max-w-4xl text-center mb-4 bounce-in relative">
        <!-- 返回按钮 -->
        <button id="backBtn" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-secondary hover:bg-secondary/80 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-300 flex items-center gap-2">
            <i class="fa fa-arrow-left"></i>
            <span>Back</span>
        </button>
        
        <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2 tracking-tight">
            <i class="fa fa-heart text-accent1 animate-pulse"></i>
            Chinese Word Games
            <i class="fa fa-heart text-accent1 animate-pulse"></i>
        </h1>
        <p class="text-secondary text-[clamp(1rem,2vw,1.25rem)]">Listen to the word and choose the correct English translation with picture!</p>
    </header>
    
    <!-- 游戏状态栏 -->
    <div class="w-full max-w-4xl bg-white/90 backdrop-blur-sm rounded-full shadow-md p-3 mb-4 flex justify-between items-center bounce-in" style="animation-delay: 0.1s">
        <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm">
            <i class="fa fa-star text-yellow-500 text-xl animate-pulse"></i>
            <span class="font-bold">Score: <span id="score" class="text-primary">0</span></span>
        </div>
        <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm">
            <i class="fa fa-smile-o text-secondary text-xl"></i>
            <span class="font-bold">Progress: <span id="progress" class="text-secondary">0/0</span></span>
        </div>
    </div>
    
    <!-- 游戏主区域 - 选项区域 -->
    <main class="w-full max-w-4xl bounce-in" style="animation-delay: 0.3s">
        <div class="bg-white rounded-3xl p-6 shadow-lg border-4 border-gradient-to-r from-accent2 to-secondary">
            <!-- 使用flex容器将播放按钮和文本放在同一行 -->
            <div class="flex items-center justify-between gap-4 mb-6">
                <button id="playBtn" class="bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 text-lg wiggle w-[140px] justify-center">
                    <i class="fa fa-play-circle"></i>
                    <span>Play</span>
                </button>
                <h3 class="flex-1 text-center text-xl font-bold text-neutral">Choose the correct answer</h3>
            </div>
            
            <!-- 选项区域 - 两列布局，增大尺寸 -->
            <div id="options" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- 选项将通过JS动态生成 -->
            </div>
        </div>
    </main>
    
    <!-- 游戏结束弹窗 -->
    <div id="gameOverModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 transform transition-all bounce-in shadow-2xl border-4 border-accent1">
            <div class="text-center mb-4">
                <i class="fa fa-trophy text-yellow-500 text-5xl animate-pulse"></i>
            </div>
            <h2 class="text-2xl font-bold text-primary text-center mb-2">Great Job!</h2>
            <p class="text-center text-neutral mb-6">Your final score: <span id="finalScore" class="font-bold text-primary text-2xl">0</span></p>
            <div class="flex flex-col justify-center gap-3">
                <button id="restartBtn" class="bg-gradient-to-r from-secondary to-accent2 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full shadow-md transition-all duration-300 text-lg wiggle">
                    Play Again
                </button>
                <button id="goBackBtn" class="bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full shadow-md transition-all duration-300 text-lg wiggle">
                    Go Back to Word Cards
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 游戏状态
        let currentWordIndex = 0;
        let score = 0;
        let usedWords = [];
        let currentWordData = null;
        let maleVoice = null; // 男性声音
        let vocabulary = [];  // 从JSON加载的词汇数据
        let dFile = 'data/words.json'; // 默认文件
        
        // 检测并获取最新的词汇文件
        async function getLatestWordFile() {
            // 先尝试检查是否存在固定命名的最新文件
            const latestFile = 'data/words_latest.json';
            try {
                const response = await fetch(latestFile, { method: 'HEAD' });
                if (response.ok) {
                    return latestFile;
                }
            } catch (err) {
                // 文件不存在时的错误忽略
            }
            
            // 如果没有固定命名的最新文件，检查带序号的文件（从1开始向上检查）
            let i = 1;
            let latestValidFile = null;
            
            while (i <= 10) { // 最多检查10个文件
                const testFile = `data/words_${i}.json`;
                try {
                    const response = await fetch(testFile, { method: 'HEAD' });
                    if (response.ok) {
                        latestValidFile = testFile;
                        i++;
                    } else {
                        break; // 一旦找到不存在的文件，就停止检查
                    }
                } catch (err) {
                    // 文件不存在时的错误忽略
                    break;
                }
            }
            
            // 返回找到的最新文件或默认文件
            return latestValidFile || 'data/words.json';
        }
        
        // DOM元素
        const playBtn = document.getElementById('playBtn');
        const optionsEl = document.getElementById('options');
        const scoreEl = document.getElementById('score');
        const progressEl = document.getElementById('progress');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const backBtn = document.getElementById('backBtn');
        const goBackBtn = document.getElementById('goBackBtn'); // 新增的返回按钮
        
        // 初始化游戏
        async function initGame() {
            try {
                // 重置游戏状态
                score = 0;
                currentWordIndex = 0;
                usedWords = [];
                scoreEl.textContent = score;
                gameOverModal.classList.add('hidden');
                optionsEl.innerHTML = '';
                
                // 更新进度显示为0/0
                progressEl.textContent = '0/0';
                finalScoreEl.textContent = '0/0';
                
                // 准备语音（优先选择男性声音）
                prepareMaleVoice();
                
                // 显示词汇选择界面
                document.getElementById('wordSelectionScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize game: ' + error.message);
            }
        }
        
        // 加载特定来源的词汇
        async function loadWordSource(sourceType, reviewCount = 0) {
            try {
                // 显示加载动画
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('wordSelectionScreen').classList.add('hidden');
                
                // 重置词汇数据
                vocabulary = [];
                
                switch(sourceType) {
                    case 'latest':
                        // 加载最新的词汇文件
                        const latestFile = await getLatestWordFile();
                        const latestResponse = await fetch(latestFile);
                        if (!latestResponse.ok) throw new Error('Failed to load latest vocabulary');
                        vocabulary = await latestResponse.json();
                        break;
                        
                    case 'old':
                        // 加载以前的单词（words.json）
                        const oldResponse = await fetch('data/words.json');
                        if (!oldResponse.ok) throw new Error('Failed to load previous vocabulary');
                        vocabulary = await oldResponse.json();
                        break;
                        
                    case 'combined':
                        // 加载最新和以前的单词并合并
                        const combinedLatestFile = await getLatestWordFile();
                        const combinedLatestResponse = await fetch(combinedLatestFile);
                        const combinedOldResponse = await fetch('data/words.json');
                        
                        if (!combinedLatestResponse.ok) throw new Error('Failed to load latest vocabulary');
                        if (!combinedOldResponse.ok) throw new Error('Failed to load previous vocabulary');
                        
                        const latestWords = await combinedLatestResponse.json();
                        const oldWords = await combinedOldResponse.json();
                        
                        // 合并词汇数据，避免重复（根据hanzi字段去重）
                        const wordMap = new Map();
                        
                        // 先添加以前的单词
                        oldWords.forEach(word => {
                            if (word.hanzi) {
                                wordMap.set(word.hanzi, word);
                            }
                        });
                        
                        // 再添加最新的单词（覆盖重复的）
                        latestWords.forEach(word => {
                            if (word.hanzi) {
                                wordMap.set(word.hanzi, word);
                            }
                        });
                        
                        // 将Map转换为数组
                        vocabulary = Array.from(wordMap.values());
                        break;
                        
                    case 'hard':
                        // 加载最新的词汇文件
                        const hardLatestFile = await getLatestWordFile();
                        const hardLatestResponse = await fetch(hardLatestFile);
                        if (!hardLatestResponse.ok) throw new Error('Failed to load latest vocabulary');
                        const hardLatestWords = await hardLatestResponse.json();
                        
                        // 加载以前的单词（words.json）
                        const hardOldResponse = await fetch('data/words.json');
                        if (!hardOldResponse.ok) throw new Error('Failed to load previous vocabulary');
                        const hardOldWords = await hardOldResponse.json();
                        
                        // 从以前的单词中随机抽取指定数量的单词
                        let selectedOldWords = [];
                        if (reviewCount > 0 && hardOldWords.length > 0) {
                            // 复制数组以避免修改原始数据
                            const oldWordsCopy = [...hardOldWords];
                            // 随机打乱数组
                            for (let i = oldWordsCopy.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [oldWordsCopy[i], oldWordsCopy[j]] = [oldWordsCopy[j], oldWordsCopy[i]];
                            }
                            // 取前reviewCount个单词
                            selectedOldWords = oldWordsCopy.slice(0, reviewCount);
                        }
                        
                        // 合并最新单词和随机抽取的以前单词
                        vocabulary = [...hardLatestWords, ...selectedOldWords];
                        break;
                }
                
                if (!vocabulary || vocabulary.length === 0) throw new Error('No vocabulary data available');
                
                // 更新进度显示
                progressEl.textContent = `0/${vocabulary.length}`;
                finalScoreEl.textContent = `0/${vocabulary.length}`;
                
                // 加载第一个词语
                loadNextWord();
                
                // 隐藏加载动画
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Error loading word source:', error);
                alert('Failed to load vocabulary: ' + error.message);
                // 隐藏加载动画，重新显示选择界面
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('wordSelectionScreen').classList.remove('hidden');
            }
        }
        
        // 准备男性声音
        function prepareMaleVoice() {
            // 等待语音合成引擎加载完成
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                // 优先选择中文男性声音
                maleVoice = voices.find(voice => 
                    (voice.lang.includes('zh-CN') || voice.lang.includes('zh')) &&
                    (voice.name.includes('Male') || voice.name.includes('男') || voice.gender === 'male')
                );
            };
            
            // 触发一次语音加载
            window.speechSynthesis.getVoices();
        }
        
        // 加载下一个词语
        function loadNextWord() {
            if (currentWordIndex >= vocabulary.length) {
                endGame(vocabulary.length);
                return;
            }
            
            // 显示加载动画
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.remove('hidden');
            }
            
            // 禁用play按钮
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // 延迟一下，让加载动画有时间显示
            setTimeout(() => {
                let reloadAttempts = 0;
                const maxReloadAttempts = 3;
                
                function attemptLoad() {
                    try {
                        // 检查词汇数据是否可用
                        if (!vocabulary || vocabulary.length === 0) {
                            throw new Error('No vocabulary data available');
                        }
                        
                        // 随机选择一个未使用的词语
                        let randomIndex;
                        do {
                            randomIndex = Math.floor(Math.random() * vocabulary.length);
                        } while (usedWords.includes(randomIndex));
                        
                        usedWords.push(randomIndex);
                        currentWordData = vocabulary[randomIndex];
                        
                        // 生成选项（仅显示英文）
                        generateOptions(currentWordData);
                        
                        // 更新进度
                        currentWordIndex++;
                        progressEl.textContent = `${currentWordIndex}/${vocabulary.length}`;
                        
                        // 加载成功，隐藏加载动画并启用按钮
                        completeLoading();
                        return true;
                    } catch (error) {
                        console.error('Error loading next word:', error);
                        reloadAttempts++;
                        
                        if (reloadAttempts <= maxReloadAttempts) {
                            console.log(`Attempting to reload (${reloadAttempts}/${maxReloadAttempts})...`);
                            // 尝试重新加载词汇数据
                            setTimeout(attemptLoad, 500);
                            return false;
                        } else {
                            console.error('Max reload attempts reached');
                            // 达到最大重试次数，隐藏加载动画并启用按钮
                            completeLoading();
                            return false;
                        }
                    }
                }
                
                // 完成加载的回调函数
                function completeLoading() {
                    // 隐藏加载动画
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                    }
                    
                    // 启用play按钮
                    if (playBtn) {
                        playBtn.disabled = false;
                        playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
                
                // 开始加载
                attemptLoad();
            }, 300); // 300ms的延迟，让加载动画有时间显示
        }
        
        // 生成选项（增大尺寸的两列布局）
        function generateOptions(currentWord) {
            optionsEl.innerHTML = '';
            
            // 从meaning中提取英文部分（去除"Meaning: "前缀）
            const englishMeaning = currentWord.meaning.replace('Meaning: ', '').split(',')[0].trim();
            
            // 收集所有可能的选项（1个正确 + 3个干扰）
            const options = [{
                english: englishMeaning,
                image: currentWord.image
            }];
            
            // 添加干扰项，从其他词汇中随机选择3个
            const otherVocabulary = vocabulary.filter(word => word !== currentWord);
            while (options.length < 4 && otherVocabulary.length > 0) {
                const randomIndex = Math.floor(Math.random() * otherVocabulary.length);
                const randomDistractor = otherVocabulary[randomIndex];
                const distractorEnglish = randomDistractor.meaning.replace('Meaning: ', '').split(',')[0].trim();
                
                if (!options.some(opt => opt.english === distractorEnglish)) {
                    options.push({
                        english: distractorEnglish,
                        image: randomDistractor.image
                    });
                    // 从候选池中移除已选择的干扰项
                    otherVocabulary.splice(randomIndex, 1);
                }
            }
            
            // 打乱选项顺序
            shuffleArray(options);
            
            // 创建选项按钮（增大尺寸）
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full py-6 px-5 border-2 border-secondary/30 rounded-xl flex items-center gap-5 option-hover font-medium text-xl shadow-sm hover:shadow';
                button.innerHTML = `
                    <div class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 border-2 border-accent1">
                        <img src="${option.image || 'https://via.placeholder.com/100'}" alt="${option.english}" class="w-full h-full object-cover">
                    </div>
                    <span><i class="fa fa-circle-o text-secondary mr-2"></i>${option.english}</span>
                `;
                button.addEventListener('click', () => checkAnswer(option.english, englishMeaning));
                optionsEl.appendChild(button);
            });
        }
        
        // 检查答案
        function checkAnswer(selectedOption, correctOption) {
            const isCorrect = selectedOption === correctOption;
            const buttons = optionsEl.querySelectorAll('button');
            
            // 禁用所有选项按钮
            buttons.forEach(btn => btn.disabled = true);
            
            // 禁用play按钮
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // 高亮显示正确和错误的选项
            buttons.forEach(btn => {
                if (btn.textContent.includes(correctOption)) {
                    btn.classList.add('bg-green-100', 'border-green-500');
                    btn.innerHTML = btn.innerHTML.replace('fa-circle-o', 'fa-check-circle text-green-500');
                    if (isCorrect) {
                        playSound('correct');
                    }
                } else if (btn.textContent.includes(selectedOption)) {
                    btn.classList.add('bg-red-100', 'border-red-500');
                    btn.innerHTML = btn.innerHTML.replace('fa-circle-o', 'fa-times-circle text-red-500');
                    if (!isCorrect) {
                        playSound('wrong');
                    }
                }
            });
            
            // 更新分数
            if (isCorrect) {
                score++;
                scoreEl.textContent = score;
                scoreEl.classList.add('wiggle');
                setTimeout(() => scoreEl.classList.remove('wiggle'), 500);
            }
            
            // 延迟加载下一个词语
            setTimeout(() => {
                loadNextWord();
            }, 2000);
        }
        
        // 播放男性语音（仅发音中文）
        function playPronunciation() {
            // 检查play按钮是否被禁用
            if (playBtn && playBtn.disabled) {
                return; // 按钮被禁用时不执行
            }
            
            if (!currentWordData) {
                // 检查是否在词汇选择界面
                const selectionScreen = document.getElementById('wordSelectionScreen');
                if (selectionScreen && !selectionScreen.classList.contains('hidden')) {
                    // 在选择界面，自动选择第一个词汇来源
                    const latestWordsBtn = document.getElementById('latestWordsBtn');
                    if (latestWordsBtn) {
                        latestWordsBtn.click();
                    }
                } else {
                    // 不在选择界面，尝试加载下一个单词
                    loadNextWord();
                    // 不需要延迟，因为loadNextWord会处理加载过程
                }
                return;
            }
            
            // 找到按钮内的span元素
            const playBtnSpan = playBtn ? playBtn.querySelector('span') : null;
            const originalText = playBtnSpan ? playBtnSpan.textContent : '';
            
            // 禁用play按钮并显示Playing状态
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // 修改span文本内容
            if (playBtnSpan) {
                playBtnSpan.textContent = 'Playing...';
            }
            
            // 停止任何正在播放的语音
            window.speechSynthesis.cancel();
            
            // 检查语音合成引擎是否就绪
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                // 语音引擎未就绪，等待就绪后再播放
                const checkVoices = () => {
                    const updatedVoices = window.speechSynthesis.getVoices();
                    if (updatedVoices.length > 0) {
                        // 语音引擎就绪，开始播放
                        startSpeech();
                    } else {
                        // 继续检查
                        setTimeout(checkVoices, 100);
                    }
                };
                checkVoices();
            } else {
                // 语音引擎已就绪，直接播放
                startSpeech();
            }
            
            // 开始播放语音
            function startSpeech() {
                try {
                    // 创建语音实例
                    const utterance = new SpeechSynthesisUtterance(currentWordData.hanzi);
                    utterance.lang = 'zh-CN';
                    
                    // 设置男性声音参数
                    if (maleVoice) {
                        utterance.voice = maleVoice;
                    }
                    utterance.rate = 0.8; // 稍慢的语速
                    utterance.pitch = 0.8; // 较低的音调
                    utterance.volume = 1; // 最大音量
                    
                    // 播放结束事件
                    utterance.onend = function() {
                        // 恢复play按钮
                        if (playBtn) {
                            playBtn.disabled = false;
                            playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        // 恢复span文本内容
                        if (playBtnSpan) {
                            playBtnSpan.textContent = originalText;
                        }
                    };
                    
                    // 播放错误事件
                    utterance.onerror = function() {
                        // 恢复play按钮
                        if (playBtn) {
                            playBtn.disabled = false;
                            playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        // 恢复span文本内容
                        if (playBtnSpan) {
                            playBtnSpan.textContent = originalText;
                        }
                    };
                    
                    // 播放语音
                    window.speechSynthesis.speak(utterance);
                    
                    // 按钮动画效果
                    if (playBtn) {
                        playBtn.classList.add('scale-95');
                        setTimeout(() => playBtn.classList.remove('scale-95'), 200);
                    }
                } catch (error) {
                    console.error('Error playing speech:', error);
                    
                    // 恢复play按钮
                    if (playBtn) {
                        playBtn.disabled = false;
                        playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    
                    // 恢复span文本内容
                    if (playBtnSpan) {
                        playBtnSpan.textContent = originalText;
                    }
                }
            }
        }
        
        // 播放音效
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.2); // E5
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } else {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
                oscillator.frequency.setValueAtTime(293.66, audioContext.currentTime + 0.2); // D4
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }
        
        // 游戏结束
        function endGame(total) {
            finalScoreEl.textContent = `${score}/${total}`;
            gameOverModal.classList.remove('hidden');
        }
        
        // 数组打乱函数
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // 事件监听
        playBtn.addEventListener('click', playPronunciation);
        restartBtn.addEventListener('click', initGame);
        backBtn.addEventListener('click', () => {
            // 返回上一页，如果没有上一页则跳转到wordcards.html
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'wordcards.html';
            }
        });
        // 新增的返回按钮事件
        goBackBtn.addEventListener('click', () => {
            window.location.href = 'wordcards.html';
        });
        
        // 词汇选择按钮事件监听器
        document.getElementById('latestWordsBtn').addEventListener('click', () => {
            loadWordSource('latest');
        });
        
        document.getElementById('oldWordsBtn').addEventListener('click', () => {
            loadWordSource('old');
        });
        
        document.getElementById('combinedWordsBtn').addEventListener('click', () => {
            loadWordSource('combined');
        });
        
        // 困难模式按钮事件监听器
        document.getElementById('hardWordsBtn').addEventListener('click', async () => {
            try {
                // 加载words.json文件获取单词总数
                const response = await fetch('data/words.json');
                if (!response.ok) throw new Error('Failed to load words.json');
                const words = await response.json();
                const maxWordCount = words ? words.length : 0;
                
                // 更新输入框的最大值
                const wordCountInput = document.getElementById('wordCountInput');
                if (wordCountInput) {
                    wordCountInput.max = maxWordCount;
                }
                
                // 更新提示信息
                const hintElement = document.querySelector('#wordCountDialog p.text-sm');
                if (hintElement) {
                    hintElement.textContent = `Minimum: 0, Maximum: ${maxWordCount} (all words from words.json)`;
                }
                
                // 显示单词数量选择对话框
                document.getElementById('wordCountDialog').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading word count:', error);
                // 即使加载失败也显示对话框，使用默认值
                document.getElementById('wordCountDialog').classList.remove('hidden');
            }
        });
        
        // 单词数量对话框事件监听器
        document.getElementById('cancelCountBtn').addEventListener('click', () => {
            document.getElementById('wordCountDialog').classList.add('hidden');
        });
        
        document.getElementById('confirmCountBtn').addEventListener('click', () => {
            const wordCountInput = document.getElementById('wordCountInput');
            const inputValue = parseInt(wordCountInput.value) || 0;
            const maxValue = parseInt(wordCountInput.max) || 0;
            // 确保输入值不超过最大值
            const wordCount = Math.min(inputValue, maxValue);
            document.getElementById('wordCountDialog').classList.add('hidden');
            loadWordSource('hard', wordCount);
        });
        
        // 词汇选择界面返回按钮事件
        document.getElementById('selectionBackBtn').addEventListener('click', () => {
            window.location.href = 'wordcards.html';
        });
        
        // 初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>