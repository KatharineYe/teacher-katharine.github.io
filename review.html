<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Chinese Learning</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF5252',
                        secondary: '#40C4FF',
                        accent1: '#FFEB3B',
                        accent2: '#76FF03',
                        accent3: '#FF4081',
                        accent4: '#BA68C8',
                        neutral: '#333333',
                    },
                    fontFamily: {
                        comic: ['Comic Sans MS', 'Chalkboard SE', 'cursive'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bounce-in {
                animation: bounce-in 0.5s ease-out;
            }
            .wiggle {
                animation: wiggle 0.5s ease-in-out;
            }
            .option-hover {
                transition: all 0.2s ease;
            }
            .option-hover:hover {
                transform: scale(1.02) translateY(-2px);
            }
            .cartoon-bg {
                background-image: 
                    radial-gradient(#FFEB3B 2px, transparent 2px),
                    radial-gradient(#40C4FF 2px, transparent 2px),
                    radial-gradient(#76FF03 2px, transparent 2px);
                background-size: 50px 50px;
                background-position: 0 0, 25px 25px, 40px 15px;
                background-color: #FFF8E1;
            }
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        @keyframes animate-run {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(-5deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }
        
        @keyframes animate-slide {
            0% { left: 0; }
            100% { left: 100%; }
        }
    </style>
</head>
<body class="cartoon-bg min-h-screen font-comic text-neutral flex flex-col items-center justify-start pt-4 pb-8 px-4">
    <!-- 加载动画 -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-50 cartoon-bg">
        <div class="loading-container relative">
            <!-- 卡通人物跑步动画 -->
            <div class="runner w-24 h-24 bg-primary rounded-full flex items-center justify-center text-white text-4xl animate-run">
                <i class="fa fa-user"></i>
            </div>
            <!-- 跑步轨迹 -->
            <div class="track absolute bottom-0 left-1/2 transform -translate-x-1/2 w-32 h-2 bg-gray-300 rounded-full overflow-hidden">
                <div class="track-line absolute top-0 left-0 h-full w-1/4 bg-secondary animate-slide"></div>
            </div>
        </div>
        <!-- 加载文本 -->
        <div class="mt-8 text-2xl font-bold text-primary animate-pulse">
            Loading Fun Words...
        </div>
        <!-- 跳动的小点 -->
        <div class="mt-4 flex gap-2">
            <div class="w-4 h-4 bg-accent1 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-4 h-4 bg-accent2 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-4 h-4 bg-accent3 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
    </div>
    <!-- 游戏标题和返回按钮 -->
    <header class="w-full max-w-4xl text-center mb-4 bounce-in relative">
        <!-- 返回按钮 -->
        <button id="backBtn" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-secondary hover:bg-secondary/80 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-300 flex items-center gap-2">
            <i class="fa fa-arrow-left"></i>
            <span>Back</span>
        </button>
        
        <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2 tracking-tight">
            <i class="fa fa-heart text-accent1 animate-pulse"></i>
            Chinese Word Games
            <i class="fa fa-heart text-accent1 animate-pulse"></i>
        </h1>
        <p class="text-secondary text-[clamp(1rem,2vw,1.25rem)]">Listen to the word and choose the correct English translation with picture!</p>
    </header>
    
    <!-- 游戏状态栏 -->
    <div class="w-full max-w-4xl bg-white/90 backdrop-blur-sm rounded-full shadow-md p-3 mb-4 flex justify-between items-center bounce-in" style="animation-delay: 0.1s">
        <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm">
            <i class="fa fa-star text-yellow-500 text-xl animate-pulse"></i>
            <span class="font-bold">Score: <span id="score" class="text-primary">0</span></span>
        </div>
        <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm">
            <i class="fa fa-smile-o text-secondary text-xl"></i>
            <span class="font-bold">Progress: <span id="progress" class="text-secondary">0/0</span></span>
        </div>
    </div>
    
    <!-- 游戏主区域 - 选项区域 -->
    <main class="w-full max-w-4xl bounce-in" style="animation-delay: 0.3s">
        <div class="bg-white rounded-3xl p-6 shadow-lg border-4 border-gradient-to-r from-accent2 to-secondary">
            <!-- 使用flex容器将播放按钮和文本放在同一行 -->
            <div class="flex items-center justify-between gap-4 mb-6">
                <button id="playBtn" class="bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 text-lg wiggle">
                    <i class="fa fa-play-circle"></i>
                    <span>Play</span>
                </button>
                <h3 class="flex-1 text-center text-xl font-bold text-neutral">Choose the correct answer</h3>
            </div>
            
            <!-- 选项区域 - 两列布局，增大尺寸 -->
            <div id="options" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- 选项将通过JS动态生成 -->
            </div>
        </div>
    </main>
    
    <!-- 游戏结束弹窗 -->
    <div id="gameOverModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 transform transition-all bounce-in shadow-2xl border-4 border-accent1">
            <div class="text-center mb-4">
                <i class="fa fa-trophy text-yellow-500 text-5xl animate-pulse"></i>
            </div>
            <h2 class="text-2xl font-bold text-primary text-center mb-2">Great Job!</h2>
            <p class="text-center text-neutral mb-6">Your final score: <span id="finalScore" class="font-bold text-primary text-2xl">0</span></p>
            <div class="flex flex-col justify-center gap-3">
                <button id="restartBtn" class="bg-gradient-to-r from-secondary to-accent2 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full shadow-md transition-all duration-300 text-lg wiggle">
                    Play Again
                </button>
                <button id="goBackBtn" class="bg-gradient-to-r from-primary to-accent3 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full shadow-md transition-all duration-300 text-lg wiggle">
                    Go Back to Word Cards
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 游戏状态
        let currentWordIndex = 0;
        let score = 0;
        let usedWords = [];
        let currentWordData = null;
        let maleVoice = null; // 男性声音
        let vocabulary = [];  // 从JSON加载的词汇数据
        let dFile = 'data/words.json'; // 默认文件
        
        // 检测并获取最大序号的JSON文件
        async function getLatestWordFile() {
            // 可能的序号范围，可根据实际情况调整
            const maxPossibleNumber = 100;
            let latestNumber = 0;
            
            // 从大到小检查文件是否存在
            for (let i = maxPossibleNumber; i >= 1; i--) {
                const testFile = `data/words_${i}.json`;
                try {
                    const response = await fetch(testFile, { method: 'HEAD' });
                    if (response.ok) {
                        latestNumber = i;
                        break; // 找到最大的序号就退出循环
                    }
                } catch (err) {
                    // 文件不存在时的错误忽略
                    continue;
                }
            }
            
            // 返回最新的文件路径
            return latestNumber > 0 ? `data/words_${latestNumber}.json` : 'data/words.json';
        }
        
        // DOM元素
        const playBtn = document.getElementById('playBtn');
        const optionsEl = document.getElementById('options');
        const scoreEl = document.getElementById('score');
        const progressEl = document.getElementById('progress');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const backBtn = document.getElementById('backBtn');
        const goBackBtn = document.getElementById('goBackBtn'); // 新增的返回按钮
        
        // 初始化游戏
        async function initGame() {
            try {
                // 显示加载动画
                document.getElementById('loadingScreen').classList.remove('hidden');
                
                // 重置游戏状态
                score = 0;
                currentWordIndex = 0;
                usedWords = [];
                scoreEl.textContent = score;
                gameOverModal.classList.add('hidden');
                optionsEl.innerHTML = '';
                
                // 获取最新的词汇文件
                dFile = await getLatestWordFile();
                
                // 加载词汇数据
                const vocabResponse = await fetch(dFile);
                
                if (!vocabResponse.ok) throw new Error('Failed to load vocabulary data');
                
                vocabulary = await vocabResponse.json();
                
                if (!vocabulary || vocabulary.length === 0) throw new Error('No vocabulary data available');
                
                // 更新进度显示
                progressEl.textContent = `0/${vocabulary.length}`;
                finalScoreEl.textContent = `0/${vocabulary.length}`;
                
                // 准备语音（优先选择男性声音）
                prepareMaleVoice();
                
                // 加载第一个词语
                loadNextWord();
                
                // 隐藏加载动画
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to load game data: ' + error.message);
                // 隐藏加载动画
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }
        
        // 准备男性声音
        function prepareMaleVoice() {
            // 等待语音合成引擎加载完成
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                // 优先选择中文男性声音
                maleVoice = voices.find(voice => 
                    (voice.lang.includes('zh-CN') || voice.lang.includes('zh')) &&
                    (voice.name.includes('Male') || voice.name.includes('男') || voice.gender === 'male')
                );
            };
            
            // 触发一次语音加载
            window.speechSynthesis.getVoices();
        }
        
        // 加载下一个词语
        function loadNextWord() {
            if (currentWordIndex >= vocabulary.length) {
                endGame(vocabulary.length);
                return;
            }
            
            // 随机选择一个未使用的词语
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * vocabulary.length);
            } while (usedWords.includes(randomIndex));
            
            usedWords.push(randomIndex);
            currentWordData = vocabulary[randomIndex];
            
            // 生成选项（仅显示英文）
            generateOptions(currentWordData);
            
            // 更新进度
            currentWordIndex++;
            progressEl.textContent = `${currentWordIndex}/${vocabulary.length}`;
        }
        
        // 生成选项（增大尺寸的两列布局）
        function generateOptions(currentWord) {
            optionsEl.innerHTML = '';
            
            // 从meaning中提取英文部分（去除"Meaning: "前缀）
            const englishMeaning = currentWord.meaning.replace('Meaning: ', '').split(',')[0].trim();
            
            // 收集所有可能的选项（1个正确 + 3个干扰）
            const options = [{
                english: englishMeaning,
                image: currentWord.image
            }];
            
            // 添加干扰项，从其他词汇中随机选择3个
            const otherVocabulary = vocabulary.filter(word => word !== currentWord);
            while (options.length < 4 && otherVocabulary.length > 0) {
                const randomIndex = Math.floor(Math.random() * otherVocabulary.length);
                const randomDistractor = otherVocabulary[randomIndex];
                const distractorEnglish = randomDistractor.meaning.replace('Meaning: ', '').split(',')[0].trim();
                
                if (!options.some(opt => opt.english === distractorEnglish)) {
                    options.push({
                        english: distractorEnglish,
                        image: randomDistractor.image
                    });
                    // 从候选池中移除已选择的干扰项
                    otherVocabulary.splice(randomIndex, 1);
                }
            }
            
            // 打乱选项顺序
            shuffleArray(options);
            
            // 创建选项按钮（增大尺寸）
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full py-6 px-5 border-2 border-secondary/30 rounded-xl flex items-center gap-5 option-hover font-medium text-xl shadow-sm hover:shadow';
                button.innerHTML = `
                    <div class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 border-2 border-accent1">
                        <img src="${option.image || 'https://via.placeholder.com/100'}" alt="${option.english}" class="w-full h-full object-cover">
                    </div>
                    <span><i class="fa fa-circle-o text-secondary mr-2"></i>${option.english}</span>
                `;
                button.addEventListener('click', () => checkAnswer(option.english, englishMeaning));
                optionsEl.appendChild(button);
            });
        }
        
        // 检查答案
        function checkAnswer(selectedOption, correctOption) {
            const isCorrect = selectedOption === correctOption;
            const buttons = optionsEl.querySelectorAll('button');
            
            // 禁用所有按钮
            buttons.forEach(btn => btn.disabled = true);
            
            // 高亮显示正确和错误的选项
            buttons.forEach(btn => {
                if (btn.textContent.includes(correctOption)) {
                    btn.classList.add('bg-green-100', 'border-green-500');
                    btn.innerHTML = btn.innerHTML.replace('fa-circle-o', 'fa-check-circle text-green-500');
                    if (isCorrect) {
                        playSound('correct');
                    }
                } else if (btn.textContent.includes(selectedOption)) {
                    btn.classList.add('bg-red-100', 'border-red-500');
                    btn.innerHTML = btn.innerHTML.replace('fa-circle-o', 'fa-times-circle text-red-500');
                    if (!isCorrect) {
                        playSound('wrong');
                    }
                }
            });
            
            // 更新分数
            if (isCorrect) {
                score++;
                scoreEl.textContent = score;
                scoreEl.classList.add('wiggle');
                setTimeout(() => scoreEl.classList.remove('wiggle'), 500);
            }
            
            // 延迟加载下一个词语
            setTimeout(() => {
                loadNextWord();
            }, 2000);
        }
        
        // 播放男性语音（仅发音中文）
        function playPronunciation() {
            if (!currentWordData) return;
            
            // 停止任何正在播放的语音
            window.speechSynthesis.cancel();
            
            // 创建语音实例
            const utterance = new SpeechSynthesisUtterance(currentWordData.hanzi);
            utterance.lang = 'zh-CN';
            
            // 设置男性声音参数
            if (maleVoice) {
                utterance.voice = maleVoice;
            }
            utterance.rate = 0.8; // 稍慢的语速
            utterance.pitch = 0.8; // 较低的音调
            utterance.volume = 1; // 最大音量
            
            // 播放语音
            window.speechSynthesis.speak(utterance);
            
            // 按钮动画效果
            playBtn.classList.add('scale-95');
            setTimeout(() => playBtn.classList.remove('scale-95'), 200);
        }
        
        // 播放音效
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.2); // E5
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } else {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
                oscillator.frequency.setValueAtTime(293.66, audioContext.currentTime + 0.2); // D4
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }
        
        // 游戏结束
        function endGame(total) {
            finalScoreEl.textContent = `${score}/${total}`;
            gameOverModal.classList.remove('hidden');
        }
        
        // 数组打乱函数
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // 事件监听
        playBtn.addEventListener('click', playPronunciation);
        restartBtn.addEventListener('click', initGame);
        backBtn.addEventListener('click', () => {
            // 返回上一页，如果没有上一页则跳转到wordcards.html
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'wordcards.html';
            }
        });
        // 新增的返回按钮事件
        goBackBtn.addEventListener('click', () => {
            window.location.href = 'wordcards.html';
        });
        
        // 初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>